---
title: "GEOG 6000 Lab 14 Spatial modeling with INLA"
author: "Simon Brewer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
    css: "../style.css"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = "center")

```

# Introduction

```{r echo=FALSE}
set.seed(1234)
library(png)
library(grid)
```

This lab provides a fairly brief introduction to using R for Bayesian analysis. The first section will cover converting some of the models we have looked at in previous labs to Bayesian models using rstan (an interface to the [stan][3] language) and [INLA][1]. We'll then go on to look at using INLA for spatial regression models. 

R has a large number of add-on packages for Bayesian analysis listed [here][2]. Some notable ones are:

- **coda**: provides routines for post-processing results
- **mcmcplots**: provides prettier visualizations of MCMC results
- **MCMCpack**: provides mainly standard statistical models in a simpler format


## Installing INLA

The INLA package is not available through the usual CRAN repositories. Instead, you'll need to install this manually. The following code will install the current stable version of INLA:

```{r eval=FALSE}

install.packages("INLA",repos=c(getOption("repos"),INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)

```

Once this is installed, we can load the libraries that we'll need for this lab

```{r message=FALSE}

library(dplyr)
library(ggplot2)
library(lme4)
library(sf)
library(INLA)
library(spdep)
library(tmap)

```

```{r echo=FALSE, message=FALSE}

load("inla_models.RData")

```

# Non-spatial models

## Linear regression

```{r}

gap <- read.csv("../datafiles/gapminderData5.csv")
gap$year2 <- gap$year - 1952
gap$gdpPercap2 <- log(gap$gdpPercap)

```

```{r}

fit_lm <- lm(lifeExp ~ gdpPercap2, gap)
summary(fit_lm)

```

### Basic INLA model

```{r eval = FALSE}

inla_lm <- inla(lifeExp ~ gdpPercap2, 
                data = gap)

```

```{r eval = FALSE}

inla_lm <- inla(lifeExp ~ gdpPercap2, 
                data = gap,
                control.compute = list(dic = TRUE, waic = TRUE),
                control.predictor = list(compute = TRUE))

```

```{r}

summary(inla_lm)

```

In the linear model, we got an estimate of the residual standard deviation of around 7.6. This is a measure of the size of the errors from the model. In the INLA output, we get an estimate of the residual precision instead, which is the inverse of the variance. To compare, we can invert this and take the squre root to convert back to standard deviation units, and to check that the models are estimating the same value:

```{r}

sqrt(1 / 0.017)

```

```{r eval = FALSE}
plot(inla_lm, plot.fixed.effects = TRUE,
     plot.random.effects = FALSE,
     plot.hyperparameters = FALSE,
     plot.predictor = FALSE)
```

```{r fig.width=6.5, fig.height=4., echo=FALSE}
img <- readPNG("inla.plots/lm-1.png")
grid.raster(img)
```

```{r eval=FALSE}
plot(inla_lm, plot.fixed.effects = FALSE,
     plot.random.effects = FALSE,
     plot.hyperparameters = TRUE,
     plot.predictor = FALSE)
```

```{r fig.width=6.5, fig.height=4., echo=FALSE}
img <- readPNG("inla.plots/lm-2.png")
grid.raster(img)
```

```{r}
plot(gap$lifeExp, inla_lm$summary.linear.predictor$mean)
abline(0,1)
```

## Generalized models

```{r}
## Binomial regression
irished <- read.csv("../datafiles/irished.csv")
irished$DVRT.cen <- irished$DVRT - mean(irished$DVRT)
```

```{r}
fit_glm <- glm(lvcert ~ DVRT.cen, 
               data = irished, 
               family = binomial(link = 'logit'))

summary(fit_glm)
```

### Basic INLA model

```{r eval=FALSE}
inla_glm <- inla(lvcert ~ DVRT.cen, 
                 data = irished, 
                 family = "binomial",
                 control.compute = list(dic = TRUE, waic = TRUE),
                 control.predictor = list(compute = TRUE))
summary(inla_glm)
```

```{r echo=FALSE}
summary(inla_glm)
```

```{r}
plot(inla_glm, plot.fixed.effects = TRUE,
     plot.random.effects = FALSE,
     plot.hyperparameters = FALSE,
     plot.predictor = FALSE)
```

## Mixed-effects models

```{r}
fit_lmer <- lmer(lifeExp ~ year2 + (1 | country), gap)
summary(fit_lmer)
```

```{r eval=FALSE}
inla_lmer <- inla(lifeExp ~ year2 + f(country, model = "iid"), 
                  data = gap)
```

```{r}
summary(inla_lmer)
```

```{r eval=FALSE}
plot(inla_lmer, plot.fixed.effects = TRUE,
     plot.random.effects = FALSE,
     plot.hyperparameters = FALSE,
     plot.predictor = FALSE)
```

```{r fig.width=6.5, fig.height=4., echo=FALSE}
img <- readPNG("inla.plots/lmer-1.png")
grid.raster(img)
```

```{r eval=FALSE}
plot(inla_lmer, plot.fixed.effects = FALSE,
     plot.random.effects = TRUE,
     plot.hyperparameters = FALSE,
     plot.predictor = FALSE, cex = 1)
```

```{r fig.width=6.5, fig.height=4., echo=FALSE}
img <- readPNG("inla.plots/lmer-2.png")
grid.raster(img)
```

```{r eval=FALSE}
plot(inla_lmer, plot.fixed.effects = FALSE,
     plot.random.effects = FALSE,
     plot.hyperparameters = TRUE,
     plot.predictor = FALSE, 
     plot.prior = TRUE)
```

```{r fig.width=6.5, fig.height=4., echo=FALSE}
img <- readPNG("inla.plots/lmer-3.png")
grid.raster(img)
```

# Spatial models

Read in the data

```{r}
ufos <- st_read("../datafiles/nuforc/ufo_sf_annual.shp")
```

```{r echo=FALSE}
load("ufo_models.RData")
```

Select only 2014

```{r}
ufos_2014 <- ufos %>%
  filter(year == 2014)
```

```{r}
p1 <- tm_shape(ufos_2014) + tm_fill("count", style = "jenks") +
  tm_borders() +
  tm_layout(main.title = "UFO sightings 2014")

p2 <- tm_shape(ufos_2014) + tm_fill("population", style = "jenks") +
  tm_borders() +
  tm_layout(main.title = "State population 2014")

tmap_arrange(p1, p2)
```

## Basic linear regression

```{r}
ufo_lm <- lm(count ~ population, ufos_2014)
summary(ufo_lm)
```

```{r eval=FALSE}
ufo_inla_lm <- inla(count ~ population,
                    data = ufos_2014,
                    control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE),
                    control.predictor = list(compute = TRUE))
```


```{r}
summary(ufo_inla_lm)
ufo_inla_lm$summary.fixed
```

Posterior distribution

```{r results='hide'}
ufo_inla_lm$marginals.fixed
ufo_inla_lm$marginals.hyperpar
```

Plot posterior distribution of intercept

```{r}
plot_df <- as.data.frame(inla.tmarginal(function(x) x, 
                                        ufo_inla_lm$marginals.fixed$`(Intercept)`))
ggplot(plot_df, aes(x = x, y = y)) +
  geom_line(size = 2) +
  scale_x_continuous("Intercept") +
  scale_y_continuous("P") +
  theme_bw()
```

Plot posterior distribution of population coefficient
```{r}
plot_df <- as.data.frame(inla.tmarginal(function(x) x, 
                                        ufo_inla_lm$marginals.fixed$population))
ggplot(plot_df, aes(x = x, y = y)) +
  geom_line(size = 2) +
  scale_x_continuous("Population") +
  scale_y_continuous("P") +
  theme_bw()
```

Plot posterior distribution of residual variance

```{r}
plot_df <- as.data.frame(inla.tmarginal(function(x) 1/x, 
                                        ufo_inla_lm$marginals.hyperpar$`Precision for the Gaussian observations`))
ggplot(plot_df, aes(x = x, y = y)) +
  geom_line(size = 2) +
  scale_x_continuous("Residual variance") +
  scale_y_continuous("P") +
  theme_bw()
```

Add an informed prior on slope

```{r eval = FALSE}
ufo_inla_lm2 <- inla(count ~ population,
                     data = ufos_2014,
                     control.fixed = list(mean = 0, prec = 0.2, 
                                          mean.intercept = 0, prec.intercept = 0.2),
                     control.family=list(hyper=list(prec=list(prior='loggamma', 
                                                              param=c(0.1,0.1)))),
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE))
```

```{r}
summary(ufo_inla_lm2)
```

## Spatial neighborhood and weight matrix

```{r}
ufos_2014$idarea <- 1:nrow(ufos_2014)
ufos_nb <- poly2nb(ufos_2014)
ufos_W <- nb2mat(ufos_nb)
```

```{r}
plot(st_geometry(ufos_2014), reset = FALSE)
plot(ufos_nb, st_coordinates(st_centroid(ufos_2014)), add = TRUE, col = 2, lwd = 2)
```

```{r eval=FALSE}
ufo_inla_bym <- inla(count ~ population + f(idarea, model = "bym2", graph = ufos_W), 
                     data = ufos_2014,
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE)
)
```

```{r}
summary(ufo_inla_bym)
```

Add a prior on the spatial term. 

```{r}
prior_bym2 <- list(
  prec = list(
    prior = "pc.prec",
    param = c(1, 0.01)),
  phi = list(
    prior = "pc",
    param = c(0.5, 2 / 3))
)
```

```{r eval = FALSE}
ufo_inla_bym2 <- inla(count ~ population + f(idarea, model = "bym2", 
                                            graph = ufos_W,
                                            hyper = prior_bym2), 
                     data = ufos_2014,
                     control.compute = list(dic = TRUE, waic = TRUE),
                     control.predictor = list(compute = TRUE),
                     control.inla = list(strategy = "adaptive",int.strategy = "eb")
)
```

```{r}
summary(ufo_inla_bym2)
```

Plot spatial effect

```{r}
ufos_2014$u <- ufo_inla_bym2$summary.random$idarea$mean[1:49]
tm_shape(ufos_2014) + tm_fill("u", style = "jenks") +
  tm_borders() +
  tm_layout(main.title = "State population 2014")
```

Plot Bayesian estimates of sightings

```{r}
ufos_2014$yhat <- ufo_inla_bym2$summary.linear.predictor$`0.025quant`
tm_shape(ufos_2014) + tm_fill("yhat", style = "jenks") +
  tm_borders() +
  tm_layout(main.title = "State population 2014")
```

## Rate model

```{r}
ufos_2014$Ei <- (sum(ufos_2014$count) / sum(ufos_2014$population)) * ufos_2014$population
ufos_2014$SIR <- ufos_2014$count / ufos_2014$Ei
tm_shape(ufos_2014) + tm_fill("SIR") + 
  tm_borders() + tm_layout(main.title = "UFO SIR 2014")
```


```{r eval=FALSE}
ufo_inla_rr <- inla(count ~ 1 + f(idarea, model = "bym2", 
                           graph = ufos_W,
                           hyper = prior_bym2), 
             data = ufos_2014, family = "poisson", E = Ei, 
             control.compute = list(dic = TRUE, waic = TRUE),
             control.predictor = list(compute = TRUE),
             control.inla = list(strategy = "adaptive",int.strategy = "eb")
)
```

```{r}
summary(ufo_inla_rr)
```


```{r}
ufos_2014$RR <- ufo_inla_rr$summary.fitted.values[, "mean"]

tm_shape(ufos_2014) + tm_fill("RR", palette = "-inferno") +
  tm_borders() +
  tm_layout(main.title = "RR")
```

```{r}
ufos_2014$exc <- sapply(ufo_inla_rr$marginals.fitted.values,
                        function(marg){1 - inla.pmarginal(q = 2, marginal = marg)})

tm_shape(ufos_2014) + tm_fill("exc", palette = "Blues") +
  tm_borders() +
  tm_layout(main.title = "Excedence probability (RR > 2)")
```

```{r}
airports <- read.csv("../datafiles/nuforc/airports.csv")
airports$lairports <- log(airports$airports)
ufos_2014 <- merge( ufos_2014, airports, by.x = "postal", by.y = "state")
ggplot(ufos_2014, aes(x = airports, y = count)) +
  scale_x_log10("Airports") + scale_y_log10("Sightings") +
  geom_point()
```

```{r}
prior_bym2 <- list(
  prec = list(
    prior = "pc.prec",
    param = c(0.6 / 0.31, 0.01)),
  phi = list(
    prior = "pc",
    param = c(0.005, 1 / 10))
)
```

```{r eval=FALSE}
ufo_inla_rr2 <- inla(count ~ lairports + 
               f(idarea, model = "bym2", 
                 graph = ufos_W,
                 hyper = prior_bym2), 
             data = ufos_2014, family = "poisson", E = Ei, 
             control.compute = list(dic = TRUE, waic = TRUE),
             control.predictor = list(compute = TRUE),
             control.inla = list(strategy = "adaptive",int.strategy = "eb")
)
```

```{r}
summary(ufo_inla_rr2)
```



[1]: https://www.r-inla.org
[2]: https://cran.r-project.org/web/views/Bayesian.html
[3]: http://mc-stan.org